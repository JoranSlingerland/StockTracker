"""Test add data to stocks held."""
import json
from pathlib import Path

from add_data_to_stocks_held import main

expected_result = [
    {
        "date": "2023-03-27",
        "symbol": "GOOGL",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.0005245005537886648,
        },
        "unrealized": {
            "cost_per_share": 10.0,
            "total_cost": 100,
            "average_fx_rate": 0.929,
            "quantity": 10,
            "open_value": 97.33379599999999,
            "high_value": 97.468704,
            "low_value": 94.83315992,
            "close_value": 95.328784,
            "total_value": 953.28784,
            "total_pl": 853.28784,
            "total_pl_percentage": 8.5328784,
        },
        "combined": {"total_pl": 852.78784, "total_pl_percentage": 8.527878399999999},
        "userid": "123",
    },
    {
        "date": "2023-03-27",
        "symbol": "aapl",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.0006790539138385973,
        },
        "unrealized": {
            "cost_per_share": 20.0,
            "total_cost": 100,
            "average_fx_rate": 0.929,
            "quantity": 5,
            "open_value": 148.808176,
            "high_value": 149.580408,
            "low_value": 146.882248,
            "close_value": 147.263712,
            "total_value": 736.3185599999999,
            "total_pl": 636.3185599999999,
            "total_pl_percentage": 6.3631855999999996,
        },
        "combined": {"total_pl": 635.8185599999999, "total_pl_percentage": 6.3581856},
        "userid": "123",
    },
    {
        "date": "2023-03-28",
        "symbol": "GOOGL",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": True,
        "realized": {
            "cost_per_share_buy": 10.0,
            "cost_per_share_sell": 20.0,
            "buy_price": 50.0,
            "sell_price": 100,
            "average_buy_fx_rate": 0.929,
            "average_sell_fx_rate": 0.929,
            "quantity": 5,
            "transaction_cost": 1.0,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 50.0,
            "total_pl": 49.0,
            "value_change_percentage": 1.0,
            "total_pl_percentage": 0.98,
        },
        "unrealized": {
            "cost_per_share": 10.0,
            "total_cost": 50.0,
            "average_fx_rate": 0.929,
            "quantity": 5,
            "open_value": 94.84919599999999,
            "high_value": 94.85845499999999,
            "low_value": 92.34926599999999,
            "close_value": 93.543677,
            "total_value": 467.718385,
            "total_pl": 417.718385,
            "total_pl_percentage": 8.354367700000001,
        },
        "combined": {"total_pl": 466.718385, "total_pl_percentage": 4.66718385},
        "userid": "123",
    },
    {
        "date": "2023-03-28",
        "symbol": "aapl",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": True,
        "realized": {
            "cost_per_share_buy": 20.0,
            "cost_per_share_sell": 30,
            "buy_price": 60.0,
            "sell_price": 90,
            "average_buy_fx_rate": 0.929,
            "average_sell_fx_rate": 0.929,
            "quantity": 3,
            "transaction_cost": 1.0,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 30.0,
            "total_pl": 29.0,
            "value_change_percentage": 0.5,
            "total_pl_percentage": 0.48333333333333334,
        },
        "unrealized": {
            "cost_per_share": 20.0,
            "total_cost": 40.0,
            "average_fx_rate": 0.929,
            "quantity": 2,
            "open_value": 146.264423,
            "high_value": 146.745891,
            "low_value": 144.42188199999998,
            "close_value": 145.968135,
            "total_value": 291.93627,
            "total_pl": 251.93626999999998,
            "total_pl_percentage": 6.29840675,
        },
        "combined": {"total_pl": 280.93627, "total_pl_percentage": 2.8093627},
        "userid": "123",
    },
    {
        "date": "2023-03-28",
        "symbol": "MSFT",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.0009810251797103728,
        },
        "unrealized": {
            "cost_per_share": 125.0,
            "total_cost": 250,
            "average_fx_rate": 0.929,
            "quantity": 2,
            "open_value": 255.353961,
            "high_value": 255.67802599999996,
            "low_value": 251.88655808999997,
            "close_value": 254.835457,
            "total_value": 509.670914,
            "total_pl": 259.670914,
            "total_pl_percentage": 1.038683656,
        },
        "combined": {"total_pl": 259.170914, "total_pl_percentage": 1.036683656},
        "userid": "123",
    },
    {
        "date": "2023-03-28",
        "symbol": "AMD",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.005710819801431598,
        },
        "unrealized": {
            "cost_per_share": 100.0,
            "total_cost": 100,
            "average_fx_rate": 0.929,
            "quantity": 1,
            "open_value": 89.59934299999999,
            "high_value": 89.75674599999999,
            "low_value": 85.988333,
            "close_value": 87.55310399999999,
            "total_value": 87.55310399999999,
            "total_pl": -12.44689600000001,
            "total_pl_percentage": -0.1244689600000001,
        },
        "combined": {
            "total_pl": -12.94689600000001,
            "total_pl_percentage": -0.1294689600000001,
        },
        "userid": "123",
    },
    {
        "date": "2023-03-29",
        "symbol": "GOOGL",
        "currency": "USD",
        "fully_realized": True,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 10.0,
            "cost_per_share_sell": 20.0,
            "buy_price": 100,
            "sell_price": 200,
            "average_buy_fx_rate": 0.929,
            "average_sell_fx_rate": 0.929,
            "quantity": 10,
            "transaction_cost": 1.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 100,
            "total_pl": 98.5,
            "value_change_percentage": 1.0,
            "total_pl_percentage": 0.985,
        },
        "unrealized": {
            "cost_per_share": 0.0,
            "total_cost": 0.0,
            "average_fx_rate": 0.0,
            "quantity": 0.0,
            "open_value": 94.516948,
            "high_value": 94.711009,
            "low_value": 93.010665,
            "close_value": 93.69449900000001,
            "total_value": 0.0,
            "total_pl": 0.0,
            "total_pl_percentage": 0.0,
        },
        "combined": {"total_pl": 98.5, "total_pl_percentage": 0.985},
        "userid": "123",
    },
    {
        "date": "2023-03-29",
        "symbol": "aapl",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": True,
        "realized": {
            "cost_per_share_buy": 20.0,
            "cost_per_share_sell": 30,
            "buy_price": 60.0,
            "sell_price": 90,
            "average_buy_fx_rate": 0.929,
            "average_sell_fx_rate": 0.929,
            "quantity": 3,
            "transaction_cost": 1.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 30.0,
            "total_pl": 28.5,
            "value_change_percentage": 0.5,
            "total_pl_percentage": 0.475,
        },
        "unrealized": {
            "cost_per_share": 35.0,
            "total_cost": 140.0,
            "average_fx_rate": 0.929,
            "quantity": 4,
            "open_value": 147.273817,
            "high_value": 148.82630500000002,
            "low_value": 147.255335,
            "close_value": 148.56755700000002,
            "total_value": 594.2702280000001,
            "total_pl": 454.2702280000001,
            "total_pl_percentage": 3.2447873428571437,
        },
        "combined": {
            "total_pl": 482.7702280000001,
            "total_pl_percentage": 2.4138511400000002,
        },
        "userid": "123",
    },
    {
        "date": "2023-03-29",
        "symbol": "MSFT",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": True,
        "realized": {
            "cost_per_share_buy": 125.0,
            "cost_per_share_sell": 270.0,
            "buy_price": 125.0,
            "sell_price": 270,
            "average_buy_fx_rate": 0.929,
            "average_sell_fx_rate": 0.929,
            "quantity": 1,
            "transaction_cost": 1.0,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 145.0,
            "total_pl": 144.0,
            "value_change_percentage": 1.16,
            "total_pl_percentage": 1.152,
        },
        "unrealized": {
            "cost_per_share": 125.0,
            "total_cost": 125.0,
            "average_fx_rate": 0.929,
            "quantity": 1,
            "open_value": 257.78693599999997,
            "high_value": 259.80128917999997,
            "low_value": 257.278681,
            "close_value": 259.219291,
            "total_value": 259.219291,
            "total_pl": 134.219291,
            "total_pl_percentage": 1.073754328,
        },
        "combined": {"total_pl": 278.219291, "total_pl_percentage": 1.112877164},
        "userid": "123",
    },
    {
        "date": "2023-03-29",
        "symbol": "AMD",
        "currency": "USD",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.005630835509341561,
        },
        "unrealized": {
            "cost_per_share": 100.0,
            "total_cost": 100,
            "average_fx_rate": 0.929,
            "quantity": 1,
            "open_value": 88.77828699999999,
            "high_value": 89.554531,
            "low_value": 87.66936700000001,
            "close_value": 88.79676900000001,
            "total_value": 88.79676900000001,
            "total_pl": -11.203230999999988,
            "total_pl_percentage": -0.11203230999999989,
        },
        "combined": {
            "total_pl": -11.703230999999988,
            "total_pl_percentage": -0.11703230999999988,
        },
        "userid": "123",
    },
    {
        "date": "2023-03-29",
        "symbol": "VWRL.AMS",
        "currency": "EUR",
        "fully_realized": False,
        "partial_realized": False,
        "realized": {
            "cost_per_share_buy": 0.0,
            "cost_per_share_sell": 0.0,
            "buy_price": 0.0,
            "sell_price": 0.0,
            "average_buy_fx_rate": 0.0,
            "average_sell_fx_rate": 0.0,
            "quantity": 0.0,
            "transaction_cost": 0.5,
            "dividend": 0.0,
            "total_dividends": 0.0,
            "value_change": 0.0,
            "total_pl": -0.5,
            "value_change_percentage": 0.0,
            "total_pl_percentage": -0.0026047093144405085,
        },
        "unrealized": {
            "cost_per_share": 50.0,
            "total_cost": 100,
            "average_fx_rate": 1.0,
            "quantity": 2,
            "open_value": 95.77,
            "high_value": 96.0,
            "low_value": 95.59,
            "close_value": 95.98,
            "total_value": 191.96,
            "total_pl": 91.96000000000001,
            "total_pl_percentage": 0.9196000000000001,
        },
        "combined": {
            "total_pl": 91.46000000000001,
            "total_pl_percentage": 0.9146000000000001,
        },
        "userid": "123",
    },
]


def test_all():
    """Test with all input"""
    with open(Path(__file__).parent / "data" / "transactions.json", "r") as f:
        mock_transactions = json.load(f)

    with open(Path(__file__).parent / "data" / "forex_data.json", "r") as f:
        mock_forex_data = json.load(f)

    with open(Path(__file__).parent / "data" / "stock_data.json", "r") as f:
        mock_stock_data = json.load(f)

    with open(Path(__file__).parent / "data" / "stocks_held_by_day.json", "r") as f:
        mock_stocks_held = json.load(f)

    result = main(
        [
            mock_stocks_held,
            mock_stock_data,
            mock_forex_data,
            mock_transactions,
            "all",
            "123",
        ]
    )

    assert result[0] is None
    assert result[1] is None
    for d in result[2]:
        d.pop("id")

    assert result[2] == expected_result
